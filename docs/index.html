<!doctype html>

<html>

	<head>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
		<script src="mqtt_sub.js" type="text/javascript"></script>
		<!-- <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> -->
		<script src="echarts.js"></script>
		<link rel="stylesheet" href="style.css">
		<title>github site test</title>
	</head>

	<body>
		
		<!-- <h1>Données temps-réel</h1> -->
	
		<div class="line" id="line1">
			<div class="tag">
				<div class="title">
					Chambre
				</div>
				<div class="data">
					<div id="chambre_temp" class="temperature">18.43°C</div>
					<div id="chambre_humi" class="humidite">57%</div>
				</div>
			</div>
			
			<div class="tag">
				<div class="title">
					Salon
				</div>
				<div class="data">
					<div id="salon_temp" class="temperature">18.43°C</div>
					<div id="salon_humi" class="humidite">57%</div>
				</div>
			</div>
		</div>
		
		<div class="line" id="line2">
			<div class="tag">
				<div class="title">
					Grenier
				</div>
				<div class="data">
					<div id="couloir_temp" class="temperature">18.43°C</div>
					<div id="couloir_humi" class="humidite">57%</div>
				</div>
			</div>
			
			<div class="tag">
				<div class="title">
					Radiateur
				</div>
				<div class="data">
					<div id="radiateur_temp" class="temperature">18.43°C</div>
					<div id="radiateur_humi" class="humidite">57%</div>
				</div>
			</div>
		</div>
		
		<div class="line" id="line3">
			<div class="tag">
				<div class="title">
					Exterieur
				</div>
				<div class="data">
					<div id="exterieur_temp" class="temperature">18.43°C</div>
					<div id="exterieur_humi" class="humidite">57%</div>
				</div>
			</div>
		</div>
		
		<div id="zoom_buttons">
			<button type="button" onclick="zoom(0.5)">12 heures</button>
			<button type="button" onclick="zoom(1)">24 heures</button>
			<button type="button" onclick="zoom(5)">5 jours</button>
			<button type="button" onclick="zoom(10)">10 jours</button>
			<button type="button" onclick="zoom(15)">15 jours</button>
			<button type="button" onclick="zoom(0)">Tout</button>
		</div>
		
		<div id="temperature_chart" style="width:99%; height:400px;"></div>
		
		<div id="humidity_chart" style="width:99%; height:400px;"></div>
		
		
		<script src="data.js"></script>
		
		<script>
		
		var times = []
		var temps = []
		var humis = []
		
		var second_y_axis = [false, false, true, false]
		
		var series_temperature = []
		var series_humidity = []
		
		var nb_days_back = 5
		
		for (let i = 0 ; i < nb_tags ; i++) {
			times.push([])
			temps.push([])
			humis.push([])
		}
		
		tags.forEach((value, index, array) => {
			value.forEach((line, id, arr) => {
				let s = line.split(",")
				let a = new Date(s[0]*1000)
				let b = s[1]
				let c = s[2]
				
				times[index].push(a)
				temps[index].push(b)
				humis[index].push(c)
			});
			
			// add temperature serie
			let serie = {}
			serie.name = labels[index]
			serie.type = "line"
			serie.data = temps[index]
			if (second_y_axis[index] === true) {
				serie.yAxisIndex = 1
			}
			series_temperature.push(serie)
			
			// add humidity serie
			serie = {}
			serie.name = labels[index]
			serie.type = "line"
			serie.data = humis[index]
			series_humidity.push(serie)
		});
		
		var humidity_chart = echarts.init(document.getElementById('humidity_chart'));
		var temperature_chart = echarts.init(document.getElementById('temperature_chart'));
		
		var option_temperature = {
			tooltip: {
				trigger: 'axis'
			},
			legend: {
				data: labels
			},
			toolbox: {
				left: 'center',
				itemSize: 25,
				top: 55,
				feature: {
					dataZoom: {
						yAxisIndex: 'none'
					},
					restore: {}
				}
			},
			xAxis: {
				type: 'category',
				data: times[0],
				min: function(value) {
					return get_min_index(value, 1)
				},
				axisLabel: {
					formatter: function(value, index) {
						let day = new Date(value).getDate()
						let month = new Date(value).getMonth() + 1
						let hour = new Date(value).getHours()
						let minute = new Date(value).getMinutes()
						
						return day+"/"+month+" "+hour+":"+minute
					}
				}
			},
			yAxis: [
				{
					type: 'value'
				},
				{
					type: 'value'
				}
			],
			series: series_temperature
		}
		
		// copy object option_temperature to option_humidity
		var option_humidity = {... option_temperature}
		option_humidity.series = series_humidity
		
		temperature_chart.setOption(option_temperature);
		humidity_chart.setOption(option_humidity);
		
		function get_min_index(value, days_back) {
			let now = new Date()
			let min_time = new Date(now.getTime() - days_back*24*3600*1000)
			
			let index = times[0].length - 1
			
			while (index > 0) {
				if (times[0][index] < min_time) {
					break
				}
				index--
			}
			
			return index
		}
		
		
		function zoom(days) {
			if (days === 0) {
				option_temperature.xAxis.min = function(value) {
					return 0
				}
				option_humidity.xAxis.min = function(value) {
					return 0
				}
				temperature_chart.setOption(option_temperature);
				humidity_chart.setOption(option_humidity);
			}
			else {
				option_temperature.xAxis.min = function(value) {
					return get_min_index(value, days)
				}
				option_humidity.xAxis.min = function(value) {
					return get_min_index(value, days)
				}
				temperature_chart.setOption(option_temperature);
				humidity_chart.setOption(option_humidity);
			}
		}
		
		
		</script>
		
	</body>


</html>
